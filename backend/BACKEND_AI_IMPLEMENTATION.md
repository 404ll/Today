# åç«¯ AI å®ç°æŒ‡å¯¼æ–‡æ¡£

## ğŸ“‹ ç›®å½•ç»“æ„

```
backend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts              # ä¸»å…¥å£æ–‡ä»¶
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â””â”€â”€ aiRoutes.ts       # AI è·¯ç”±
â”‚   â””â”€â”€ services/
â”‚       â””â”€â”€ aiService.ts      # AI æœåŠ¡é€»è¾‘
â”œâ”€â”€ .env                      # ç¯å¢ƒå˜é‡ï¼ˆéœ€è¦åˆ›å»ºï¼‰
â”œâ”€â”€ package.json
â””â”€â”€ tsconfig.json
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
cd backend
npm install
```

### 2. é…ç½®ç¯å¢ƒå˜é‡

åˆ›å»º `.env` æ–‡ä»¶ï¼ˆå‚è€ƒ `env.example`ï¼‰ï¼š

```bash
# æœåŠ¡å™¨é…ç½®
PORT=3000
NODE_ENV=development

# OpenAI é…ç½®
OPENAI_API_KEY=sk-your-openai-api-key-here
OPENAI_MODEL=gpt-3.5-turbo  # å¯é€‰ï¼Œé»˜è®¤ä½¿ç”¨ gpt-3.5-turbo
```

### 3. å¯åŠ¨å¼€å‘æœåŠ¡å™¨

```bash
npm run dev
```

æœåŠ¡å™¨å°†åœ¨ `http://localhost:3000` å¯åŠ¨ã€‚

## ğŸ“¡ API ç«¯ç‚¹

### POST /api/ai/chat

å¤„ç† AI èŠå¤©è¯·æ±‚ã€‚

**è¯·æ±‚ä½“ï¼š**
```json
{
  "messages": [
    { "role": "user", "content": "æˆ‘æƒ³å­¦ä¹  React" },
    { "role": "ai", "content": "å¥½çš„ï¼Œæˆ‘æ¥å¸®ä½ åˆ¶å®šå­¦ä¹ è®¡åˆ’" }
  ],
  "generateTodos": false
}
```

**å“åº”ï¼š**
```json
{
  "message": "AI çš„å›å¤å†…å®¹",
  "todos": [
    {
      "id": "todo-1234567890-0",
      "text": "å­¦ä¹  React åŸºç¡€",
      "completed": false
    }
  ]
}
```

**é”™è¯¯å“åº”ï¼š**
```json
{
  "error": "ValidationError",
  "message": "messages å¿…é¡»æ˜¯æ•°ç»„"
}
```

### GET /api/ai/health

æ£€æŸ¥ AI æœåŠ¡å¥åº·çŠ¶æ€ã€‚

**å“åº”ï¼š**
```json
{
  "status": "healthy",
  "message": "AI æœåŠ¡å¯ç”¨",
  "hasApiKey": true
}
```

## ğŸ”§ ä»£ç å®ç°è¯´æ˜

### 1. ä¸»å…¥å£æ–‡ä»¶ (index.ts)

**èŒè´£ï¼š**
- åˆå§‹åŒ– Express åº”ç”¨
- é…ç½®ä¸­é—´ä»¶ï¼ˆCORSã€JSON è§£æï¼‰
- æ³¨å†Œè·¯ç”±
- é”™è¯¯å¤„ç†
- å¯åŠ¨æœåŠ¡å™¨

**å…³é”®ç‚¹ï¼š**
- ä½¿ç”¨ `dotenv` åŠ è½½ç¯å¢ƒå˜é‡
- é…ç½® CORS å…è®¸å‰ç«¯è·¨åŸŸè¯·æ±‚
- ç»Ÿä¸€çš„é”™è¯¯å¤„ç†ä¸­é—´ä»¶

### 2. AI æœåŠ¡ (aiService.ts)

**æ ¸å¿ƒå‡½æ•°ï¼š**

#### `callOpenAI(messages)`
- **åŠŸèƒ½**ï¼šè°ƒç”¨ OpenAI API
- **è¾“å…¥**ï¼šæ¶ˆæ¯å†å²æ•°ç»„
- **è¾“å‡º**ï¼šAI çš„æ–‡æœ¬å›å¤
- **é”™è¯¯å¤„ç†**ï¼šåŒºåˆ†ä¸åŒç±»å‹çš„é”™è¯¯ï¼ˆ401ã€429ã€500ï¼‰

#### `extractTodosFromMessage(message)`
- **åŠŸèƒ½**ï¼šä» AI å›å¤ä¸­æå–å¾…åŠäº‹é¡¹
- **æ”¯æŒæ ¼å¼**ï¼š
  - `1. ä»»åŠ¡`
  - `- ä»»åŠ¡`
  - `â€¢ ä»»åŠ¡`
  - `1) ä»»åŠ¡`

#### `extractTodosFromJSON(message)`
- **åŠŸèƒ½**ï¼šå°è¯•ä» JSON æ ¼å¼ä¸­æå–å¾…åŠäº‹é¡¹
- **ä¼˜å…ˆçº§**ï¼šé«˜äºæ–‡æœ¬æå–

#### `generateTodos(userGoal, existingTodos)`
- **åŠŸèƒ½**ï¼šä¸“é—¨ç”Ÿæˆå­¦ä¹ è®¡åˆ’çš„å¾…åŠäº‹é¡¹
- **ç‰¹ç‚¹**ï¼šä½¿ç”¨ä¸“é—¨çš„ promptï¼Œç”Ÿæˆæ›´å‡†ç¡®çš„ä»»åŠ¡

#### `handleAIChat(messages, generateTodosFlag)`
- **åŠŸèƒ½**ï¼šä¸»è¦çš„ AI æœåŠ¡å‡½æ•°
- **æµç¨‹**ï¼š
  1. è°ƒç”¨ AI è·å–å›å¤
  2. å°è¯•æå–å¾…åŠäº‹é¡¹
  3. è¿”å›ç»“æœ

### 3. AI è·¯ç”± (aiRoutes.ts)

**èŒè´£ï¼š**
- æ¥æ”¶ HTTP è¯·æ±‚
- éªŒè¯è¯·æ±‚æ•°æ®
- è°ƒç”¨æœåŠ¡å±‚
- è¿”å›å“åº”
- é”™è¯¯å¤„ç†

**éªŒè¯é€»è¾‘ï¼š**
- æ£€æŸ¥ `messages` æ˜¯å¦ä¸ºæ•°ç»„
- éªŒè¯æ¯ä¸ªæ¶ˆæ¯çš„æ ¼å¼
- æ£€æŸ¥ `role` æ˜¯å¦æœ‰æ•ˆ

## ğŸ¯ å®ç°è¦ç‚¹

### 1. é”™è¯¯å¤„ç†

**åˆ†å±‚é”™è¯¯å¤„ç†ï¼š**
- æœåŠ¡å±‚ï¼šæŠ›å‡ºå…·ä½“é”™è¯¯
- è·¯ç”±å±‚ï¼šæ•è·é”™è¯¯ï¼Œè¿”å› HTTP çŠ¶æ€ç 
- ä¸»å…¥å£ï¼šå…¨å±€é”™è¯¯å¤„ç†ä¸­é—´ä»¶

**é”™è¯¯ç±»å‹ï¼š**
- `400`ï¼šè¯·æ±‚éªŒè¯å¤±è´¥
- `429`ï¼šAPI è°ƒç”¨é¢‘ç‡è¿‡é«˜
- `500`ï¼šæœåŠ¡å™¨å†…éƒ¨é”™è¯¯

### 2. ç±»å‹å®‰å…¨

**ä½¿ç”¨ TypeScript ç±»å‹ï¼š**
```typescript
interface Message {
  role: 'user' | 'ai' | 'assistant';
  content: string;
}

interface AIResponse {
  message: string;
  todos?: Todo[];
}
```

### 3. ç¯å¢ƒå˜é‡ç®¡ç†

**å¿…éœ€çš„ç¯å¢ƒå˜é‡ï¼š**
- `OPENAI_API_KEY`ï¼šOpenAI API å¯†é’¥

**å¯é€‰çš„ç¯å¢ƒå˜é‡ï¼š**
- `PORT`ï¼šæœåŠ¡å™¨ç«¯å£ï¼ˆé»˜è®¤ 3000ï¼‰
- `OPENAI_MODEL`ï¼šä½¿ç”¨çš„æ¨¡å‹ï¼ˆé»˜è®¤ gpt-3.5-turboï¼‰
- `NODE_ENV`ï¼šç¯å¢ƒï¼ˆdevelopment/productionï¼‰

### 4. å¾…åŠäº‹é¡¹æå–ç­–ç•¥

**ä¼˜å…ˆçº§ï¼š**
1. JSON æ ¼å¼æå–ï¼ˆæœ€å‡†ç¡®ï¼‰
2. æ–‡æœ¬æ ¼å¼æå–ï¼ˆæ­£åˆ™åŒ¹é…ï¼‰
3. ä¸“é—¨ç”Ÿæˆï¼ˆå¦‚æœ `generateTodos` ä¸º trueï¼‰

## ğŸ” æµ‹è¯•å»ºè®®

### 1. ä½¿ç”¨ curl æµ‹è¯•

```bash
# æµ‹è¯•å¥åº·æ£€æŸ¥
curl http://localhost:3000/api/ai/health

# æµ‹è¯•èŠå¤©
curl -X POST http://localhost:3000/api/ai/chat \
  -H "Content-Type: application/json" \
  -d '{
    "messages": [
      { "role": "user", "content": "æˆ‘æƒ³å­¦ä¹  React" }
    ]
  }'
```

### 2. ä½¿ç”¨ Postman æˆ–ç±»ä¼¼å·¥å…·

1. åˆ›å»º POST è¯·æ±‚åˆ° `http://localhost:3000/api/ai/chat`
2. è®¾ç½® Headersï¼š`Content-Type: application/json`
3. è®¾ç½® Bodyï¼ˆJSONï¼‰ï¼š
```json
{
  "messages": [
    { "role": "user", "content": "æˆ‘æƒ³å­¦ä¹  React" }
  ]
}
```

### 3. æµ‹è¯•åœºæ™¯

- âœ… æ­£å¸¸è¯·æ±‚ï¼šå‘é€æ¶ˆæ¯ï¼Œè·å– AI å›å¤
- âœ… ç”Ÿæˆå¾…åŠäº‹é¡¹ï¼šè®¾ç½® `generateTodos: true`
- âœ… é”™è¯¯å¤„ç†ï¼šå‘é€æ— æ•ˆæ•°æ®ï¼Œæ£€æŸ¥é”™è¯¯å“åº”
- âœ… é•¿å¯¹è¯ï¼šå‘é€å¤šæ¡æ¶ˆæ¯ï¼Œæµ‹è¯•ä¸Šä¸‹æ–‡ç†è§£

## ğŸš¨ å¸¸è§é—®é¢˜

### é—®é¢˜ 1ï¼šOpenAI API Key æ— æ•ˆ

**é”™è¯¯ä¿¡æ¯ï¼š** `OpenAI API Key æ— æ•ˆ`

**è§£å†³æ–¹æ¡ˆï¼š**
1. æ£€æŸ¥ `.env` æ–‡ä»¶ä¸­çš„ `OPENAI_API_KEY`
2. ç¡®ä¿ API Key æ ¼å¼æ­£ç¡®ï¼ˆä»¥ `sk-` å¼€å¤´ï¼‰
3. æ£€æŸ¥ API Key æ˜¯å¦è¿‡æœŸæˆ–è¢«æ’¤é”€

### é—®é¢˜ 2ï¼šAPI è°ƒç”¨é¢‘ç‡è¿‡é«˜

**é”™è¯¯ä¿¡æ¯ï¼š** `API è°ƒç”¨é¢‘ç‡è¿‡é«˜ï¼Œè¯·ç¨åé‡è¯•`

**è§£å†³æ–¹æ¡ˆï¼š**
1. ç­‰å¾…ä¸€æ®µæ—¶é—´åé‡è¯•
2. æ£€æŸ¥ OpenAI è´¦æˆ·çš„é€Ÿç‡é™åˆ¶
3. è€ƒè™‘å‡çº§è´¦æˆ·æˆ–å®ç°è¯·æ±‚é˜Ÿåˆ—

### é—®é¢˜ 3ï¼šCORS é”™è¯¯

**é”™è¯¯ä¿¡æ¯ï¼š** å‰ç«¯æ— æ³•è®¿é—®åç«¯ API

**è§£å†³æ–¹æ¡ˆï¼š**
1. æ£€æŸ¥ `index.ts` ä¸­çš„ CORS é…ç½®
2. ç¡®ä¿å‰ç«¯è¯·æ±‚çš„ URL æ­£ç¡®
3. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°çš„é”™è¯¯ä¿¡æ¯

### é—®é¢˜ 4ï¼šå¾…åŠäº‹é¡¹æå–å¤±è´¥

**é—®é¢˜ï¼š** AI å›å¤äº†ï¼Œä½†æ²¡æœ‰æå–åˆ°å¾…åŠäº‹é¡¹

**è§£å†³æ–¹æ¡ˆï¼š**
1. æ£€æŸ¥ AI å›å¤çš„æ ¼å¼æ˜¯å¦ç¬¦åˆé¢„æœŸ
2. æ”¹è¿› `extractTodosFromMessage` çš„æ­£åˆ™è¡¨è¾¾å¼
3. ä½¿ç”¨ `generateTodos: true` å¼ºåˆ¶ç”Ÿæˆ

## ğŸ”„ ä¸‹ä¸€æ­¥ä¼˜åŒ–

### 1. æ·»åŠ è¯·æ±‚é™æµ

ä½¿ç”¨ `express-rate-limit` é™åˆ¶è¯·æ±‚é¢‘ç‡ï¼š

```bash
npm install express-rate-limit
```

### 2. æ·»åŠ æ—¥å¿—è®°å½•

ä½¿ç”¨ `winston` æˆ– `pino` è®°å½•è¯·æ±‚å’Œé”™è¯¯ï¼š

```bash
npm install winston
```

### 3. æ·»åŠ ç¼“å­˜

ä½¿ç”¨ Redis ç¼“å­˜ç›¸ä¼¼çš„ AI å›å¤ï¼Œå‡å°‘ API è°ƒç”¨ï¼š

```bash
npm install redis
```

### 4. æµå¼å“åº”

å®ç° Server-Sent Events (SSE) æ”¯æŒæµå¼å“åº”ï¼š

```typescript
// ä½¿ç”¨ OpenAI çš„ stream é€‰é¡¹
const stream = await openai.chat.completions.create({
  // ... é…ç½®
  stream: true,
});
```

### 5. æ·»åŠ ç”¨æˆ·è®¤è¯

ä½¿ç”¨ JWT æˆ– OAuth ä¿æŠ¤ APIï¼š

```bash
npm install jsonwebtoken
```

## ğŸ“š ç›¸å…³èµ„æº

- [OpenAI API æ–‡æ¡£](https://platform.openai.com/docs/api-reference)
- [Express.js æ–‡æ¡£](https://expressjs.com/)
- [TypeScript æ–‡æ¡£](https://www.typescriptlang.org/docs/)

## âœ… æ£€æŸ¥æ¸…å•

åœ¨å¼€å§‹ä½¿ç”¨å‰ï¼Œç¡®ä¿ï¼š

- [ ] å·²å®‰è£…æ‰€æœ‰ä¾èµ– (`npm install`)
- [ ] å·²åˆ›å»º `.env` æ–‡ä»¶å¹¶é…ç½® `OPENAI_API_KEY`
- [ ] æœåŠ¡å™¨å¯ä»¥æ­£å¸¸å¯åŠ¨ (`npm run dev`)
- [ ] å¥åº·æ£€æŸ¥ç«¯ç‚¹è¿”å›æ­£å¸¸ (`/api/ai/health`)
- [ ] å¯ä»¥æˆåŠŸè°ƒç”¨ AI èŠå¤©æ¥å£
- [ ] å‰ç«¯å¯ä»¥æ­£å¸¸è¿æ¥åç«¯

---

**éœ€è¦å¸®åŠ©ï¼Ÿ** æŸ¥çœ‹ä»£ç æ³¨é‡Šæˆ–è”ç³»å¼€å‘å›¢é˜Ÿã€‚

